(function(a){window.NestedFormEvents=function(){this.addFields=a.proxy(this.addFields,this),this.removeFields=a.proxy(this.removeFields,this)},NestedFormEvents.prototype={addFields:function(b){var c=b.currentTarget,d=a(c).data("association"),e=a("#"+a(c).data("blueprint-id")),f=e.data("blueprint"),g=(a(c).closest(".fields").closestChild("input, textarea, select").eq(0).attr("name")||"").replace(new RegExp("[[a-z_]+]$"),"");if(g){var h=g.match(/[a-z_]+_attributes(?=\]\[(new_)?\d+\])/g)||[],i=g.match(/[0-9]+/g)||[];for(var j=0;j<h.length;j++)i[j]&&(f=f.replace(new RegExp("(_"+h[j]+")_.+?_","g"),"$1_"+i[j]+"_"),f=f.replace(new RegExp("(\\["+h[j]+"\\])\\[.+?\\]","g"),"$1["+i[j]+"]"))}var k=new RegExp("new_"+d,"g"),l=this.newId();f=a.trim(f.replace(k,l));var m=this.insertFields(f,d,c);return m.trigger({type:"nested:fieldAdded",field:m}).trigger({type:"nested:fieldAdded:"+d,field:m}),!1},newId:function(){return(new Date).getTime()},insertFields:function(b,c,d){var e=a(d).data("target");return e?a(b).appendTo(a(e)):a(b).insertBefore(d)},removeFields:function(b){var c=a(b.currentTarget),d=c.data("association"),e=c.prev("input[type=hidden]");e.val("1");var f=c.closest(".fields");return f.hide(),f.trigger({type:"nested:fieldRemoved",field:f}).trigger({type:"nested:fieldRemoved:"+d,field:f}),!1}},window.nestedFormEvents=new NestedFormEvents,a(document).delegate("form a.add_nested_fields","click",nestedFormEvents.addFields).delegate("form a.remove_nested_fields","click",nestedFormEvents.removeFields)})(jQuery),function(a){a.fn.closestChild=function(b){if(b&&b!=""){var c=[];c.push(this);while(c.length>0){var d=c.shift(),e=d.children();for(var f=0;f<e.length;++f){var g=a(e[f]);if(g.is(b))return g;c.push(g)}}}return a()}}(jQuery);